#!/usr/bin/env bash
bash -n "$0" | exit 1

source ${TESTSROOTDIR}/tools/runit_common.sh

FILENAMELEN=32

function kill_pids() {
	pids=$1

	for pid in $pids;
	do
		kill -9 $pid
	done
}

function create_remove_file_loop() {
	local dbdir=$1

	while true;
	do
		local rand_fname=$(cat /dev/urandom | tr -cd 'a-f0-9' | head -c $FILENAMELEN)

		touch $dbdir/$rand_fname
		sleep .1

		rm $dbdir/$rand_fname
		sleep .1
	done
}

function test_comdb2_files_restricted_file() {
	(
		# Given
		local dbname=$1 dbdir=$2
		echo "restricted blahblah" > $dbdir/restrictedFile
		chmod 000 $dbdir/restrictedFile
		trap "chmod 777 $dbdir/restrictedFile; rm $dbdir/restrictedFile" EXIT

		# When
		cdb2sql $dbname local 'select count(*) from comdb2_files' > /dev/null

		# Then
		return $?
	)
}

function test_comdb2_files_restricted_directory() {
	(
		# Given
		local dbname=$1 dbdir=$2
		mkdir $dbdir/restrictedDir
		touch $dbdir/restrictedDir/f
		chmod 000 $dbdir/restrictedDir
		trap "chmod 777 $dbdir/restrictedDir; rm -rf $dbdir/restrictedDir" EXIT

		# When
		cdb2sql $dbname local 'select count(*) from comdb2_files' > /dev/null

		# Then
		return $?
	)
}

function test_comdb2_files_large_file() {
	(
		# Given
		local dbname=$1 dbdir=$2
		exp_size=$(( 24 * 1024*1024))
		truncate -s $exp_size $dbdir/largefile
		trap "rm $dbdir/largefile" EXIT

		# When
		res_size=$(cdb2sql -tabs $dbname local "select sum(size) from comdb2_files where filename like '%largefile%'")

		# Then
		query_rc=$?
		if (( query_rc == 0 && res_size == exp_size )); then 
			return 0
		else 
			return 1
		fi
	)
}

function test_comdb2_files_broken_symlink() {
	(
		# Given
		local dbname=$1 dbdir=$2
		ln -s idonutexist $dbdir/link
		trap "rm $dbdir/link" EXIT

		# When
		cdb2sql $dbname local 'select count(*) from comdb2_files' > /dev/null

		# Then
		query_rc=$?
		if (( query_rc != 0 )); then
			return 0
		else
			return 1
		fi
	)
}

function test_comdb2_files_delete_race() {
	(
		# Given
		local dbname=$1 dbdir=$2 n_parallel_threads=10 pids=()
		for i in $(seq $n_parallel_threads);
		do
			create_remove_file_loop $dbdir &
			pids[${i}]=$!
		done
		pid_str="${pids[@]}"
		trap "kill_pids \"$pid_str\"" EXIT

		sleep .1

		# When
		cdb2sql $dbname local 'select count(*) from comdb2_files' > /dev/null

		# Then
		query_rc=$?
		return $query_rc
	)
}

function runtest {
	local dbname=$1 dbdir=$2
	local tests=$(compgen -A function | grep -oh "test_\w*")

	for testcase in $tests;
	do
		if ! $testcase $dbname $dbdir;
		then
			failexit "$testcase"
		fi
		echo "Passed $testcase"
	done
}

function main() {
	local dbname=$1
	if [ -z "$CLUSTER" ];
	then
		runtest $dbname $DBDIR
	else
		node=`echo $CLUSTER | awk '{ print $1}'`
		ssh $node "export PATH=$PATH; $(typeset -f); runtest $dbname $DBDIR"
	fi
	
	rc=$?
	return $rc
}

main $1
